# todo源码

**包名：org.vaadin.marcus.spring**

## User.java(model子包)

```java
package org.vaadin.marcus.spring.model;

import com.fasterxml.jackson.annotation.JsonFormat;
import com.fasterxml.jackson.databind.annotation.JsonDeserialize;
import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;
import com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;

import java.time.LocalDateTime;

/**
 * @author joe
 * @date 2021/6/7
 */
public class User {
    //定义私有的用户名和密码变量
    private String userName;
    private String password;
    //json依赖（对于时间的依赖）
    @JsonDeserialize(using = LocalDateTimeDeserializer.class)
    @JsonSerialize(using = LocalDateTimeSerializer.class)
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime gmtCreated;
    //变量的get和set方法

    public String getUserName() {
        return userName;
    }

    public void setUserName(String userName) {
        this.userName = userName;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public LocalDateTime getGmtCreated() {
        return gmtCreated;
    }

    public void setGmtCreated(LocalDateTime gmtCreated) {
        this.gmtCreated = gmtCreated;
    }
}

```

## Application.java

两个框架的主函数（vaadin和spring）

```java
package org.vaadin.marcus.spring;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;

/**
 * The entry point of the Spring Boot application.
 */
@SpringBootApplication
public class Application extends SpringBootServletInitializer {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}

```

## 登录窗口的实现（LoginView.java）

```java
package org.vaadin.marcus.spring;

import com.vaadin.flow.component.ClickEvent;
import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.html.H1;
import com.vaadin.flow.component.html.Label;
import com.vaadin.flow.component.login.AbstractLogin;
import com.vaadin.flow.component.login.LoginForm;
import com.vaadin.flow.component.notification.Notification;
import com.vaadin.flow.component.orderedlayout.HorizontalLayout;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.server.VaadinService;
import org.vaadin.marcus.spring.model.User;

import javax.servlet.http.Cookie;

/**
 * @author joe
 * @date 2021/6/15
 */
//注解：通过这个login.html访问这个页面
@Route("login.html")
//继承于垂直分布
public class LoginView extends VerticalLayout {
    //定义登录页面的基本形式
    private LoginForm loginForm = new LoginForm();
    //构造函数
    public LoginView() {
        //设置登录页面的位置，居中放置
        setJustifyContentMode(JustifyContentMode.CENTER);
        setAlignItems(Alignment.CENTER);
        //去除忘记密码的操作
        loginForm.setForgotPasswordButtonVisible(false);
        //定义大标题
        H1 h1 = new H1("TODO");
        //定义水平布局变量
        HorizontalLayout regLayout = new HorizontalLayout();
        //居中放置
        regLayout.setAlignItems(Alignment.CENTER);
        //定义一个提示语（是否有账户）
        Label tips = new Label("Don’t have an account?");
        //定义一个注册按钮
        Button regBtn = new Button("Sign up here.");
        //将按钮转换为链接的形式
        regBtn.setThemeName("tertiary");
        //设置点击事件
        regBtn.addClickListener(this::onSign);
        //对水平布局增加提示语和注册按钮
        regLayout.add(tips, regBtn);
        //对登录页面进行登录的操作
        loginForm.addLoginListener(this::onLogin);

        // 把所有内容添加到页面上
        add(h1, regLayout, loginForm);

    }

    //定义一个注册的方法
    public void onSign(ClickEvent event){
        //定义一个跳转页面
        getUI().ifPresent(ui -> {
            ui.navigate("/reg.html");
        });
    }
   //定义一个登录的方法
    public void onLogin(AbstractLogin.LoginEvent event){
        //定义两个变量分别来接收你输入的用户名和密码
        String userName = event.getUsername();
        String password = event.getPassword();
        //
        for (User user : Reg.users) {
            //判断是否登录成功
            if (user.getUserName().equals(userName) && user.getPassword().equals(password)){
                //弹窗
                Notification notification = new Notification();
                notification.setDuration(3000);
                notification.setText("login success");
                notification.open();
                //定义一个Cookie值
                Cookie cookie = new Cookie("username",userName);
    
                //Cookie的值默认在主目录
                cookie.setPath("/");
              

                //把Cookie存放在服务器上
                VaadinService.getCurrentResponse().addCookie(cookie);
                

                System.out.println(getUI().isPresent());

                getUI().ifPresent(ui -> {
                    ui.navigate("/");
                });

                return;
            }
        }

        loginForm.setError(true);
        
    }


}

```

## 注册页面（Reg.java)

```JAVA
package org.vaadin.marcus.spring;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.notification.Notification;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.textfield.TextField;
import com.vaadin.flow.router.Route;
import org.apache.commons.io.FileUtils;
import org.vaadin.marcus.spring.model.User;

import java.io.File;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

/**
 * @author joe
 * @date 2021/6/7
 */
@Route("/reg.html")
public class Reg extends VerticalLayout {

    public static List<User> users = new ArrayList<>();

    private static ObjectMapper mapper = new ObjectMapper();
    private static File usersFile = new File("./data/users.json");

    static {

        if (usersFile.exists()) {
            try {
               String content = FileUtils.readFileToString(usersFile, "utf-8");

                List<User> userList = mapper.readValue(content, new TypeReference<List<User>>() {
                });

                users.addAll(userList);

            } catch (Exception e) {
                e.printStackTrace();
            }
        }

    }

    public Reg() {

        TextField userNameField = new TextField();
        initUserNameField(userNameField);

        TextField passwordField = new TextField();
        initPasswordField(passwordField);

        TextField confirmPasswordField = new TextField();
        initConfirmPasswordField(confirmPasswordField);

        Button regButton = new Button("Reg");

        regButton.addClickListener(click -> {
            onReg(userNameField, passwordField, confirmPasswordField);
        });

        add(userNameField);
        add(passwordField);
        add(confirmPasswordField);
        add(regButton);

    }

    public void initUserNameField(TextField userNameField) {
        String userName = "UserName";
        userNameField.setLabel(userName);
        userNameField.setPlaceholder("please input username");
    }

    public void initPasswordField(TextField passwordField) {
        String password = "Password";
        passwordField.setLabel(password);
        passwordField.setPlaceholder("please input password");
    }

    public void initConfirmPasswordField(TextField passwordField) {
        String password = "Confirm Password";
        passwordField.setLabel(password);
        passwordField.setPlaceholder("please input confirm password");
    }

    public void onReg(TextField userNameField, TextField passwordField, TextField confirmPasswordField) {
        String userNameText = userNameField.getValue();
        String pwdText = passwordField.getValue();
        String confirmPwdText = confirmPasswordField.getValue();

        Notification notification = new Notification();
        notification.setDuration(3000);

        if (userNameText == null || "".equals(userNameText)) {
            notification.setText("need input username");
            notification.open();
            // 程序执行到这就结束啦，后面的代码不再执行咯
            return;
        }

        if (pwdText != null && !"".equals(pwdText) && pwdText.equals(confirmPwdText)) {

            for (User user : users) {

                if (userNameText.equals(user.getUserName())){
                    notification.setText("username already reg");
                    notification.open();
                    return;
                }

            }

            User user = new User();
            user.setUserName(userNameText);
            user.setPassword(pwdText);

            LocalDateTime gmtCreated = LocalDateTime.now();
            user.setGmtCreated(gmtCreated);

            users.add(user);

            String userName = user.getUserName();

            notification.setText("reg success " + userName);

            try {
                String content = mapper.writeValueAsString(users);
                FileUtils.writeStringToFile(usersFile, content, "utf-8");
            } catch (Exception e) {
                e.printStackTrace();
            }

        } else {
            notification.setText("confirm pwd error");
        }
        notification.open();

    }

}

```

## todo页面（todo.java）

```java
package org.vaadin.marcus.spring;

import com.vaadin.flow.component.ClickEvent;
import com.vaadin.flow.component.UI;
import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.checkbox.Checkbox;
import com.vaadin.flow.component.html.H1;
import com.vaadin.flow.component.html.H4;
import com.vaadin.flow.component.orderedlayout.HorizontalLayout;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.textfield.TextField;
import com.vaadin.flow.router.*;
import com.vaadin.flow.server.VaadinService;

import javax.servlet.http.Cookie;

@Route("/")
public class Todo extends VerticalLayout implements AfterNavigationObserver {
    private VerticalLayout todoList = new VerticalLayout();
    private TextField todoField = new TextField();

    public Todo() {
        Button addButton = new Button("Add");
        addButton.addClickListener(this::onAdd);

        add(new H1("TODO"), new H4("Hello " + getUserName()), todoList, new HorizontalLayout(todoField, addButton));

    }

    public String getUserName() {
        for (Cookie cookie : VaadinService.getCurrentRequest().getCookies()) {
            if (cookie.getName().equals("username")) {
                return cookie.getValue();
            }

        }
        return "";
    }

    public void onAdd(ClickEvent event) {
        String todoVal = todoField.getValue();
        Checkbox checkbox = new Checkbox(todoVal);
        todoList.add(checkbox);
    }

    @Override
    public void afterNavigation(AfterNavigationEvent afterNavigationEvent) {

        for (Cookie cookie : VaadinService.getCurrentRequest().getCookies()) {
            if (cookie.getName().equals("username")) {
                return;
            }
        }

        getUI().ifPresent(ui -> {
            ui.navigate("/login.html");
        });

    }
}

```

