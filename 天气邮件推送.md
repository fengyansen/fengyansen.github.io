# 天气邮件推送

## 依赖

```java
<dependencies>
        <dependency>
          <groupId>com.squareup.okhttp3</groupId>
          <artifactId>okhttp</artifactId>
          <version>4.1.0</version>
        </dependency>
        <dependency>
            <groupId>javax.mail</groupId>
            <artifactId>mail</artifactId>
            <version>1.4</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.62</version>
        </dependency>
        <dependency>
          <groupId>org.apache.commons</groupId>
          <artifactId>commons-lang3</artifactId>
          <version>3.9</version>
        </dependency>
    </dependencies>
```



## Mail.java

```java
package com.youkeda.test.j3.c9;

import java.security.Security;
import java.util.Properties;
import javax.mail.Authenticator;
import javax.mail.Message;
import javax.mail.PasswordAuthentication;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;

public class Mail {

  private static final String SSL_FACTORY = "javax.net.ssl.SSLSocketFactory";
  private static Properties props = null;

  // TODO:发件人信箱
  private static final String FROM_MAIL = "";
  // TODO:发件人信箱安全key
  private static final String FROM_MAIL_KEY = "";
  // TODO:收件人信箱
  private static final String TO_MAIL = "";

  /**
   * 在构造函数中初始化相关的参数。这是固定用法。
   */
  public Mail() {
    // 设置SSL连接、邮件环境
    props = System.getProperties();
    props.setProperty("mail.smtp.host", "smtp.qq.com");
    props.setProperty("mail.smtp.socketFactory.class", SSL_FACTORY);
    props.setProperty("mail.smtp.socketFactory.fallback", "false");
    props.setProperty("mail.smtp.port", "465");
    props.setProperty("mail.smtp.socketFactory.port", "465");
    props.setProperty("mail.smtp.auth", "true");
  }

  /**
   * 发送邮件
   * @param subject
   * @param content
   */
  public void sendMail(String subject, String content) {
    try {
      // 建立邮件会话
      Session session = Session.getDefaultInstance(props, new Authenticator() {
        // 身份认证
        protected PasswordAuthentication getPasswordAuthentication() {
          // 账户 授权码
          return new PasswordAuthentication(FROM_MAIL, FROM_MAIL_KEY);
        }
      });

      // 建立邮件对象
      MimeMessage message = new MimeMessage(session);
      // 设置邮件的发件人、收件人、主题
      // 附带发件人名字
      message.setFrom(new InternetAddress(FROM_MAIL));
      message.setRecipients(Message.RecipientType.TO, TO_MAIL);
      message.setSubject(subject);
      // 文本部分
      message.setContent(content, "text/html;charset=UTF-8");
      message.saveChanges();
      // 发送邮件
      Transport.send(message);
    } catch (Exception e) {
      e.printStackTrace();
    }
  }
}

```

WeatherNotice.java

```java
package com.youkeda.test.j3.c9;

import com.alibaba.fastjson.JSON;
import com.youkeda.test.j3.c9.model.Weather;
import java.time.LocalDate;

public class WeatherNotice {

  public static void main(String[] args) {
    WeatherPicker wp = new WeatherPicker();
    String content = wp.pick();
    Weather weather = JSON.parseObject(content, Weather.class);
    String cityName = weather.getWeatherinfo().getCity();
    String temp = weather.getWeatherinfo().getTemp();
    String time = weather.getWeatherinfo().getTime();
    LocalDate today = LocalDate.now();
    String todayStr = today.toString();

    String title = "天气报告";
    String mailContent = cityName + "，" + todayStr + " " + time + "，气温：" + temp + "摄氏度。";
    try {
      Double tempNum = Double.valueOf(temp);
      if (tempNum <= 20) {
        mailContent += "请注意保暖。";
      } else if (tempNum >= 35) {
        mailContent += "请注意防暑。";
      } else {
        mailContent += "请注意天气变化。";
      }

      Mail mail = new Mail();
      mail.sendMail(title, mailContent);

      System.out.println("Send complete");
    } catch (Exception e) {
      e.printStackTrace();
    }

  }
}
```

WeatherPicker.java

```java
package com.youkeda.test.j3.c9;

import java.io.IOException;
import okhttp3.Call;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import org.apache.commons.lang3.StringUtils;

public class WeatherPicker {

  // okHttpClient 实例
  private OkHttpClient okHttpClient;

  public WeatherPicker() {
    //1. 构建 okHttpClient 实例
    okHttpClient = new OkHttpClient();
  }

  /**
   * 根据输入的url，读取页面内容并返回
   */
  private String getPageContentSync(String url) {
    // 参数判断，未输入参数则直接返回
    if (StringUtils.isBlank(url)) {
      return null;
    }

    //2.定义一个request
    Request request = new Request.Builder().url(url).build();
    //3.使用client去请求
    Call call = okHttpClient.newCall(request);
    String result = null;
    try {
      //4.获得返回结果
      result = call.execute().body().string();
      System.out.println("call " + url + " , content's size=" + result.length());
    } catch (IOException e) {
      System.out.println("request " + url + " error . ");
      e.printStackTrace();
    }

    return result;
  }

  public String pick() {
    String content = getPageContentSync("http://www.weather.com.cn/data/sk/101210106.html");
    return content;
  }

  public String pick(String url) {
    String content = getPageContentSync(url);
    return content;
  }
}

```











